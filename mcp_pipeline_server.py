from mcp.server.fastmcp import FastMCP
from openai import OpenAI
import os
from dotenv import load_dotenv


load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

mcp = FastMCP("pipeline-server")

# --- 1: searchDocs ---
@mcp.tool()
async def search_docs(query: str) -> str:
    """
    Ищет текст в "документах". Для примера — просто возвращает строку.
    """
    fake_documents = {
        "python": """
    Python — высокоуровневый язык программирования, впервые представленный Гвидо ван Россумом в 1991 году.
    Он ориентирован на повышение продуктивности разработчика и читабельность кода за счёт лаконичного синтаксиса
    и строгой структуры отступов.

    Язык имеет огромную экосистему библиотек: от web-фреймворков (Django, FastAPI) до инструментов для науки
    и анализа данных (NumPy, Pandas, SciPy). Python широко применяется в машинном обучении благодаря таким
    библиотекам и фреймворкам, как TensorFlow, PyTorch и scikit-learn.

    Одним из ключевых преимуществ Python является его интерпретируемость и возможность быстрого прототипирования.
    Разработчики также ценят обширное сообщество, огромное количество готовых решений и простоту интеграции с
    C/C++ при необходимости оптимизации вычислений.
    """,

        "flutter": """
    Flutter — UI-фреймворк от Google для разработки кроссплатформенных приложений под Android, iOS, Web, Windows,
    macOS и Linux. Он использует язык Dart и собственный высокопроизводительный движок рендеринга, что позволяет
    добиваться стабильных 60/120 FPS и полностью контролировать внешний вид интерфейса.

    Flutter позволяет создавать нативные по ощущениям приложения без необходимости поддерживать несколько
    разных кодовых баз. Виджеты, компонуемые декларативным способом, дают разработчикам удобный способ
    описания UI. Hot Reload обеспечивает мгновенный отклик при изменении кода.

    Фреймворк активно используется в производстве: Google, Alibaba, BMW, ByteDance и многие другие компании
    выпускают крупные продукты на Flutter.

    Экосистема включает тысячи пакетов и плагинов: для работы с сетью, доступа к нативным API, анимаций,
    управления состоянием, архитектуры, Firebase, MLKit и многого другого. Flutter также активно применяется
    в enterprise-разработке благодаря стабильности и хорошей поддержке Google.
    """,

        "dart": """
    Dart — язык программирования, разработанный Google, и основной язык фреймворка Flutter. Он поддерживает JIT
    (Just-In-Time) для быстрой разработки и AOT (Ahead-Of-Time) для высокопроизводительных релизных сборок.

    Основные особенности:
    - Строгая типизация с выводом типов
    - Асинхронность через Future/Stream и отличный event-loop
    - Современный синтаксис, похожий на смесь JavaScript и Kotlin
    - Высокая скорость выполнения благодаря AOT-компиляции

    Dart прекрасно подходит не только для Flutter, но и для серверной разработки (Dart Frog, Shelf), CLI-утилит,
    и даже Web-приложений через Dart → JavaScript транспиляцию.
    """,

        "ml": """
    Machine Learning (машинное обучение) — область искусственного интеллекта, которая изучает алгоритмы,
    способные обучаться на данных и делать выводы без явного программирования. Основная идея ML заключается
    в том, что модель находит закономерности в примерах и затем применяет их на новых данных.

    Ключевые направления ML:
    - Обучение с учителем (classification, regression)
    - Обучение без учителя (clustering, dimensionality reduction)
    - Обучение с подкреплением
    - Генеративные модели (GAN, Diffusion, Transformers)

    ML активно используется в реальной жизни: в банковских скоринговых системах, медицине, рекомендательных
    системах, автономных автомобилях, распознавании речи, компьютерном зрении и многом другом.

    Современный ML плотно связан с глубокими нейронными сетями, и за последние годы методы deep learning
    показали значительный прогресс благодаря GPU и большим датасетам.
    """,

        "ai": """
    Artificial Intelligence — широкая область, цель которой создать системы, способные решать задачи, требующие
    «интеллекта»: понимание речи, планирование, обучение, генерация контента, принятие решений.

    Современный искусственный интеллект в основном строится на основе:
    - Машинного обучения
    - Нейронных сетей
    - Гигантских моделей (LLM, VLM)
    - Методов оптимизации

    С появлением архитектуры Transformer (Google, 2017) произошёл революционный скачок в NLP, а затем и в работе
    с изображениями, аудио, видео и мультимодальными данными. Модели вроде GPT-4, Claude, Gemini, Llama и Qwen
    показали способность к рассуждению, кодированию, анализу сложных сценариев и выполнению агентных действий.

    AI активно внедряется в бизнес: автоматизация процессов, чат-боты, системы поддержки принятия решений,
    генерация документации, поиск информации, автотесты, анализ логов, безопасность.
    """
    }

    result = [text for k, text in fake_documents.items() if query.lower() in k.lower()]
    return "\n".join(result) if result else "Ничего не найдено."


# --- 2: summarize ---
@mcp.tool()
async def summarize_text(text: str) -> str:
    """
    Суммаризация текста с использованием OpenAI Responses API.
    """

    if not text.strip():
        return "Нет текста для суммаризации."

    # Создаём запрос к Responses API
    response = client.responses.create(
        model="gpt-4.1-mini",
        input=f"Сделай краткое резюме на 1 предложение следующего текста:\n{text}",
    )

    # Достаём нормальный ассистентский текст из output
    summary_parts = []
    for item in response.output:
        if item.type == "message" and item.role == "assistant":
            for block in item.content:
                if block.type == "output_text":
                    summary_parts.append(block.text)

    if summary_parts:
        return "\n".join(summary_parts).strip()

    return "Не удалось получить суммаризацию."


# --- 3: saveToFile ---
@mcp.tool()
async def save_to_file(filename: str, content: str) -> str:
    """
    Сохраняет данные в файл.
    """
    path = os.path.join(os.getcwd(), filename)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    return f"Сохранено в файл {path}"


if __name__ == "__main__":
    mcp.run()
