# CloudDocs - Документация по авторизации

## Обзор системы авторизации

CloudDocs использует современную систему авторизации на основе JWT токенов с поддержкой OAuth 2.0 и двухфакторной аутентификации.

---

## Типы авторизации

### 1. Email + Password
Классический метод входа:
- Email должен быть подтвержден
- Пароль минимум 8 символов (рекомендуется 12+)
- Поддержка "Запомнить меня" на 30 дней
- Автоматическая блокировка после 5 неудачных попыток

### 2. OAuth провайдеры
Поддерживаемые провайдеры:
- Google Account
- Microsoft Account
- Apple ID
- GitHub (для Enterprise)

### 3. SSO (Single Sign-On)
Доступно для Enterprise планов:
- SAML 2.0
- OpenID Connect
- Active Directory интеграция
- Custom identity providers

---

## Безопасность

### Хеширование паролей
- Алгоритм: bcrypt с cost factor 12
- Salt: уникальный для каждого пароля
- Хранение: только хеш, пароль никогда не сохраняется

### JWT токены
- Access token: живет 15 минут
- Refresh token: живет 30 дней
- Подпись: RS256 (RSA)
- Payload: user_id, email, plan, permissions

### Двухфакторная аутентификация (2FA)
- TOTP (Time-based One-Time Password)
- Совместимость: Google Authenticator, Authy, 1Password
- Резервные коды: 10 одноразовых кодов
- Обязательна для Enterprise планов

---

## Процесс авторизации

### Шаг 1: Ввод учетных данных
```
POST /api/auth/login
{
  "email": "user@example.com",
  "password": "secure_password",
  "remember_me": true
}
```

### Шаг 2: Проверка учетных данных
1. Проверка существования пользователя
2. Сверка хеша пароля
3. Проверка статуса аккаунта (активен/заблокирован)
4. Проверка наличия 2FA

### Шаг 3: 2FA (если включена)
```
POST /api/auth/verify-2fa
{
  "code": "123456",
  "session_id": "temp_session_id"
}
```

### Шаг 4: Выдача токенов
```
Response:
{
  "access_token": "eyJhbGc...",
  "refresh_token": "eyJhbGc...",
  "expires_in": 900,
  "user": {
    "id": "user_123",
    "email": "user@example.com",
    "plan": "premium"
  }
}
```

---

## Обновление токенов

### Автоматическое обновление
Клиент автоматически обновляет access token используя refresh token:

```
POST /api/auth/refresh
{
  "refresh_token": "eyJhbGc..."
}
```

### Инвалидация токенов
Токены инвалидируются при:
- Смене пароля
- Выходе из аккаунта
- Блокировке аккаунта
- Удалении аккаунта
- Ручной инвалидации через "Завершить все сессии"

---

## Управление сессиями

### Активные сессии
Пользователь может видеть и управлять активными сессиями:
- Устройство и браузер
- IP адрес и геолокация
- Дата и время входа
- Последняя активность

### Завершение сессии
```
POST /api/auth/logout
Authorization: Bearer {access_token}
```

### Завершение всех сессий
```
POST /api/auth/logout-all
Authorization: Bearer {access_token}
```

---

## Восстановление доступа

### Сброс пароля
1. Пользователь запрашивает сброс:
```
POST /api/auth/forgot-password
{
  "email": "user@example.com"
}
```

2. Система отправляет письмо с токеном (действителен 1 час)

3. Пользователь устанавливает новый пароль:
```
POST /api/auth/reset-password
{
  "token": "reset_token",
  "new_password": "new_secure_password"
}
```

### Восстановление 2FA
Если утерян доступ к 2FA:
1. Использовать резервные коды
2. Запросить отключение 2FA через email
3. Подтвердить личность (документы для Enterprise)

---

## Коды ошибок

### 401 Unauthorized
**Причины:**
- Неверный email или пароль
- Истек срок токена
- Токен инвалидирован
- Аккаунт не активирован

**Решение:**
- Проверьте учетные данные
- Обновите токен
- Подтвердите email
- Свяжитесь с поддержкой

### 403 Forbidden
**Причины:**
- Аккаунт заблокирован
- Недостаточно прав доступа
- IP адрес в черном списке
- Превышен rate limit

**Решение:**
- Проверьте статус аккаунта
- Проверьте права доступа
- Используйте другую сеть
- Подождите и попробуйте снова

### 429 Too Many Requests
**Причины:**
- Превышен лимит попыток входа (5 в 15 минут)
- Превышен лимит запросов API

**Решение:**
- Подождите 15 минут
- Используйте rate limiting в клиенте
- Увеличьте план для большего лимита

---

## Troubleshooting

### Проблема: Ошибка 401 после успешного входа
**Диагностика:**
1. Проверьте время на устройстве (должно быть точным)
2. Проверьте наличие cookies
3. Проверьте локальное хранилище браузера
4. Проверьте наличие блокировщиков рекламы

**Решение:**
- Синхронизируйте время устройства
- Разрешите cookies для clouddocs.example.com
- Отключите расширения браузера
- Попробуйте режим инкогнито

### Проблема: Не приходит письмо для сброса пароля
**Диагностика:**
1. Проверьте правильность email
2. Проверьте папку "Спам"
3. Проверьте лимиты почтового ящика

**Решение:**
- Добавьте noreply@clouddocs.example.com в белый список
- Запросите отправку повторно через 5 минут
- Попробуйте другой email
- Свяжитесь с поддержкой

### Проблема: 2FA код не принимается
**Диагностика:**
1. Проверьте время на устройстве
2. Проверьте правильность ввода
3. Убедитесь что используете актуальный код

**Решение:**
- Синхронизируйте время (разница не должна превышать 30 секунд)
- Подождите новый код (обновляется каждые 30 секунд)
- Используйте резервный код
- Запросите отключение 2FA через email

---

## Best Practices

### Для пользователей
1. Используйте уникальный сложный пароль
2. Включите 2FA
3. Не делитесь учетными данными
4. Регулярно проверяйте активные сессии
5. Используйте менеджер паролей

### Для разработчиков
1. Всегда используйте HTTPS
2. Храните токены в httpOnly cookies
3. Реализуйте refresh token rotation
4. Логируйте попытки авторизации
5. Мониторьте подозрительную активность

---

## API Reference

### Endpoints

```
POST   /api/auth/register          # Регистрация
POST   /api/auth/login             # Вход
POST   /api/auth/logout            # Выход
POST   /api/auth/refresh           # Обновление токена
POST   /api/auth/forgot-password   # Запрос сброса пароля
POST   /api/auth/reset-password    # Сброс пароля
POST   /api/auth/verify-email      # Подтверждение email
POST   /api/auth/verify-2fa        # Проверка 2FA кода
GET    /api/auth/sessions          # Список активных сессий
DELETE /api/auth/sessions/:id      # Завершить сессию
POST   /api/auth/enable-2fa        # Включить 2FA
POST   /api/auth/disable-2fa       # Отключить 2FA
```

### Rate Limits
- Login: 5 попыток / 15 минут
- Password reset: 3 запроса / час
- API calls: зависит от плана
  - Free: 100 запросов / час
  - Premium: 1000 запросов / час
  - Enterprise: без ограничений

---

## Контакты поддержки

При проблемах с авторизацией:
- Email: security@clouddocs.example.com
- Приоритет: High (ответ в течение 2 часов)
- Telegram: @clouddocs_security (только для Enterprise)
